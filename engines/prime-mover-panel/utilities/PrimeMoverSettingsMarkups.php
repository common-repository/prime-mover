<?php
namespace Codexonics\PrimeMoverFramework\utilities;

/*
 * This file is part of the Codexonics.PrimeMoverFramework package.
 *
 * (c) Codexonics Ltd
 *
 * This package is Open Source Software. For the full copyright and license
 * information, please view the LICENSE file which was distributed with this
 * source code.
 */

use Codexonics\PrimeMoverFramework\classes\PrimeMover;

if (! defined('ABSPATH')) {
    exit;
}

/**
 * Prime Mover common settings markup
 *
 */
class PrimeMoverSettingsMarkups
{     
    private $prime_mover;
    
    /**
     * Construct
     * @param PrimeMover $prime_mover
     * @param array $utilities
     */
    public function __construct(PrimeMover $prime_mover, $utilities = [])
    {
        $this->prime_mover = $prime_mover;
    }

    /**
     * Get multisite migration
     * @return \Codexonics\PrimeMoverFramework\classes\PrimeMover
     * @compatible 5.6
     */
    public function getPrimeMover()
    {
        return $this->prime_mover;
    }
    
    /**
     * Render submit button
     * @param string $nonce_key
     * @param string $button_id
     * @param string $spinner_class
     * @param string $wrapper
     * @param string $button_classes
     * @param string $button_text
     * @param string $disabled
     * @param string $title
     * @param boolean $pro
     * @param number $blog_id
     */
    public function renderSubmitButton($nonce_key = '', $button_id = '', $spinner_class = '', $wrapper = 'div', $button_classes = 'button-primary', 
        $button_text = '', $disabled = '', $title = '', $pro = true, $blog_id = 0)
    {
        $spinner_class = "$spinner_class prime_mover_settings_spinner";
        $main_opening_tag = '<div class="p_wrapper_prime_mover_setting">';
        $main_closing_tag = '</div>';
        $spinner_tag = '<div class="' . esc_attr($spinner_class) . '"></div>';
        if ('p' === $wrapper) {
            $main_opening_tag = '<p class="p_wrapper_prime_mover_setting">';
            $main_closing_tag = '</p>';
            $spinner_tag = '<span class="' . esc_attr($spinner_class) . '"></span>';
        }
        if ( ! $button_text ) {
            $button_text =  __('Save', 'prime-mover');
        }
        echo $main_opening_tag;      
        $render = false;
        if ($blog_id) {
            $render = apply_filters('prime_mover_multisite_blog_is_licensed', false, $blog_id);            
        } else {
            $render = apply_filters('prime_mover_is_loggedin_customer', false);
        }
        if (!$render && $pro) {            
    ?>        
            <a title="<?php esc_attr_e('This is PRO feature setting. Please upgrade to use this setting.', 'prime-mover'); ?>" 
            class="prime-mover-upgrade-button-simple button" href="<?php echo esc_url($this->getPrimeMover()->getSystemInitialization()->getUpgradeUrl()); ?>">
            <i class="dashicons dashicons-cart prime-mover-cart-dashicon"></i><?php esc_html_e('Upgrade to PRO', 'prime-mover'); ?></a>
     <?php        
        } else {
       ?>
            <button title="<?php echo esc_attr($title);?>" <?php echo esc_html($disabled); ?> data-prime-mover-blogid-panel="<?php echo esc_attr($blog_id); ?>" data-nonce="<?php echo $this->getPrimeMover()->getSystemFunctions()->primeMoverCreateNonce($nonce_key); ?>" 
            id="<?php echo esc_attr($button_id);?>" class="<?php echo esc_attr($button_classes);?>" type="button">
            <?php echo esc_html($button_text);?></button>
            <?php echo $spinner_tag; ?>   
    <?php    
        }          
        echo $main_closing_tag;
    }
    
    /**
     * Generate download URL for log
     * @param string $nonce_key
     * @param string $nonce_arg
     * @param string $arg_key
     * @param number $blog_id
     * @return string|mixed
     */
    public function generateDownloadLogUrl($nonce_key = '', $nonce_arg = '', $arg_key = '', $blog_id = 0)
    {
        $nonce = $this->getPrimeMover()->getSystemFunctions()->primeMoverCreateNonce($nonce_key);
        $params = [$arg_key => 'yes', $nonce_arg => $nonce];
        if ($blog_id) {
            $params['autobackup_blogid'] = $blog_id;
        }
        
        return esc_url(add_query_arg($params));
    }
    
    /**
     * Start markup
     * @param string $heading
     */
    public function startMarkup($heading = '')
    {
        ?>
        <table class="form-table">
        <tbody>
        <tr>
            <th scope="row">
                <label><?php echo esc_html($heading); ?></label>
            </th>
            <td>                      
                <div class="prime-mover-setting-description">
    <?php    
    }
    
    /**
     * End markup
     */
    public function endMarkup()
    {
        ?>
                </div>                      
            </td>
        </tr>
        </tbody>
        </table>
    <?php        
    }
}
